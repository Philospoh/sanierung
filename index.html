<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sanierungsrechner – Schnell-Indikation</title>
  <style>
    :root{
      --bg:#fafafa; --card:#fff; --txt:#111; --mut:#60646c;
      --bd:#e6e8eb; --bd2:#d9dde3; --accent:#111; --soft:#f4f6f8;
      --ok:#effff5; --warn:#fff6e5;
      --r:16px; --shadow:0 1px 2px rgba(0,0,0,.05);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--txt)}
    .wrap{max-width:980px;margin:24px auto 64px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:var(--r);box-shadow:var(--shadow);padding:16px;margin:12px 0}
    h1{font-size:22px;margin:6px 0 8px}
    h2{font-size:16px;margin:0 0 10px}
    .muted{color:var(--mut);font-size:13px;line-height:1.35}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col12{grid-column:span 12}
    .col8{grid-column:span 8}
    .col6{grid-column:span 6}
    .col4{grid-column:span 4}
    @media (max-width:860px){ .col8,.col6,.col4{grid-column:span 12} }

    label{display:block;font-size:13px;color:#2b2f36;margin:0 0 6px}
    input,select{
      width:100%; padding:10px 11px; border:1px solid var(--bd2);
      border-radius:12px; font-size:14px; background:#fff;
    }
    input::placeholder{color:#9aa3ad}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{
      display:flex;align-items:flex-start;gap:10px;
      border:1px solid var(--bd);border-radius:999px;padding:10px 12px;background:#fff;
    }
    .pill input{width:auto;margin-top:2px}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:10px 12px;
      font-weight:650;cursor:pointer;background:var(--accent);color:#fff;
    }
    .btn.secondary{background:#fff;color:var(--txt);border:1px solid var(--bd2)}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .progress{
      height:10px;border-radius:999px;background:var(--soft);
      overflow:hidden;border:1px solid var(--bd);
    }
    .bar{height:100%;width:0%;background:#111}
    .stepTitle{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .badge{font-size:12px;color:#2b2f36;background:var(--soft);border:1px solid var(--bd);padding:6px 10px;border-radius:999px}
    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .kpi{grid-column:span 4;border:1px dashed var(--bd2);border-radius:14px;padding:12px}
    .kpi b{display:block;font-size:18px;margin-top:4px}
    @media (max-width:860px){ .kpi{grid-column:span 12} }
    .box{border:1px solid var(--bd);border-radius:14px;padding:12px}
    .box.ok{background:var(--ok);border-color:#bff0d0}
    .box.warn{background:var(--warn);border-color:#ffe0a3}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--bd);padding:10px 8px;text-align:left;font-size:13px}
    .table th{color:#2b2f36;font-weight:700;background:var(--soft)}
    .right{text-align:right}
    .cta{display:flex;flex-direction:column;gap:8px}
    .cta a{display:inline-block;text-decoration:none}
    .small{font-size:12px;color:var(--mut);line-height:1.35}
    .hidden{display:none !important}
  </style>
</head>

<body>
<div class="wrap">

  <div class="card">
    <h1>Sanierungsrechner (Schnell-Indikation)</h1>
    <p class="muted">
      In wenigen Schritten erhältst du eine grobe Kostenspanne und eine Einspar-Indikation.
      Keine Förderzusage, keine Detailplanung – dafür schnell und transparent.
    </p>
  </div>

  <div class="card">
    <div class="stepTitle">
      <div>
        <h2 id="stepHeading">Schritt 1 von 4</h2>
        <div class="muted" id="stepSub">Gebäude & Basisdaten</div>
      </div>
      <div class="badge">V1 Website</div>
    </div>
    <div class="progress" aria-label="Fortschritt"><div class="bar" id="bar"></div></div>
  </div>

  <!-- STEP 1 -->
  <div class="card" id="step1">
    <h2>Gebäude & Basisdaten</h2>
    <div class="grid">
      <div class="col4">
        <label>Gebäudetyp</label>
        <select id="buildingType">
          <option value="efh">Einfamilienhaus</option>
          <option value="rh">Reihenhaus</option>
          <option value="mfh">Mehrfamilienhaus</option>
        </select>
      </div>
      <div class="col4">
        <label>Baujahr (Klasse)</label>
        <select id="baujahr">
          <option value="bis_1978">bis 1978</option>
          <option value="1979_1994">1979–1994</option>
          <option value="1995_2009">1995–2009</option>
          <option value="ab_2010">ab 2010</option>
        </select>
      </div>
      <div class="col4">
        <label>Wohnfläche (m²)</label>
        <input id="wf" inputmode="decimal" placeholder="z.B. 140" value="140">
      </div>

      <div class="col6">
        <label>Energieträger Heizung</label>
        <select id="fuel">
          <option value="gas">Erdgas</option>
          <option value="oil">Heizöl</option>
          <option value="district">Fernwärme</option>
          <option value="electric">Strom (direkt)</option>
        </select>
      </div>
      <div class="col6">
        <label>Optional: Jahresverbrauch (kWh/Jahr)</label>
        <input id="kwh" inputmode="decimal" placeholder="z.B. 22.000 oder 22000">
      </div>

      <div class="col12">
        <div class="box warn">
          <div class="small">
            Hinweis: Wenn du deinen realen Verbrauch einträgst, wird die Einspar-Indikation deutlich passender.
            Ohne Verbrauch nutzt der Rechner typische Richtwerte nach Baujahrklasse.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card hidden" id="step2">
    <h2>Maßnahmen auswählen</h2>
    <div class="muted" style="margin-bottom:10px">
      Wähle die Maßnahmen, die dich interessieren. Die Ergebnisse werden als Kosten-Spannen ausgegeben.
    </div>
    <div class="row" id="measures"></div>

    <div class="box" style="margin-top:12px">
      <div class="grid">
        <div class="col6">
          <label>Optional: Energiepreis (€/kWh)</label>
          <input id="price" inputmode="decimal" placeholder="z.B. 0,12 oder 0.12">
          <div class="small" id="priceHint" style="margin-top:6px"></div>
        </div>
        <div class="col6">
          <label>Preisniveau / Risikopuffer</label>
          <select id="uplift">
            <option value="0">0% (neutral)</option>
            <option value="10">+10% (vorsichtig)</option>
            <option value="20">+20% (sehr vorsichtig)</option>
          </select>
          <div class="small" style="margin-top:6px">
            Damit kannst du regionale/marktbedingte Abweichungen grob abbilden.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="card hidden" id="step3">
    <h2>Zusammenfassung & Berechnung</h2>
    <div class="grid">
      <div class="col8">
        <div class="box">
          <div class="muted">Deine Eingaben</div>
          <div id="summary" style="margin-top:8px"></div>
        </div>
      </div>
      <div class="col4">
        <div class="box ok">
          <div class="muted">Berechnung starten</div>
          <button class="btn" id="calcBtn" style="margin-top:10px;width:100%">Ergebnis anzeigen</button>
          <div class="small" style="margin-top:8px">
            Alle Berechnungen laufen lokal im Browser. Es werden keine Daten automatisch gespeichert oder übertragen.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 4 -->
  <div class="card hidden" id="step4">
    <h2>Ergebnis (Indikation)</h2>

    <div class="kpis">
      <div class="kpi">
        <span class="muted">Investition gesamt</span>
        <b id="invTotal">–</b>
        <span class="small" id="invRange">–</span>
      </div>
      <div class="kpi">
        <span class="muted">Jährliche Einsparung</span>
        <b id="savEur">–</b>
        <span class="small" id="savKwh">–</span>
      </div>
      <div class="kpi">
        <span class="muted">CO₂-Minderung</span>
        <b id="co2">–</b>
        <span class="small">kg CO₂/Jahr (indikativ)</span>
      </div>
    </div>

    <div class="box" style="margin-top:12px">
      <div class="muted" style="margin-bottom:8px">Kosten je Maßnahme (Spanne)</div>
      <table class="table" aria-label="Kosten je Maßnahme">
        <thead>
          <tr>
            <th>Maßnahme</th>
            <th class="right">Kosten min</th>
            <th class="right">Kosten typisch</th>
            <th class="right">Kosten max</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="col8">
        <div class="box warn">
          <div class="muted" style="margin-bottom:6px">Wichtig</div>
          <div class="small" id="assumptions"></div>
        </div>
      </div>
      <div class="col4">
        <div class="box ok cta">
          <div class="muted">Nächster Schritt</div>
          <a class="btn" href="#kontakt">Erstberatung / iSFP anfragen</a>
          <div class="small">
            Belastbare Werte entstehen erst nach Vor-Ort-Daten (Bauteilaufbau, U-Werte, Anlagentechnik, Nutzerprofil).
          </div>
          <button class="btn secondary" id="restartBtn">Neue Berechnung</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <button class="btn secondary" id="backBtn" disabled>Zurück</button>
      <button class="btn" id="nextBtn">Weiter</button>
    </div>
  </div>

</div>

<script>
/* =========================
   KONFIG
========================= */
const baselineKwhPerM2 = {
  bis_1978: 190,
  1979_1994: 140,
  1995_2009: 100,
  ab_2010: 70
};

const defaultPrices = {
  gas: 0.12,
  oil: 0.12,
  district: 0.14,
  electric: 0.30
};

const co2Factors = {
  gas: 0.20088,
  oil: 0.2664,
  district: 0.18,
  electric: 0.363
};

const measuresConfig = [
  { id:"heat", label:"Heizung optimieren / tauschen", savePctTyp:0.25, costModel:"flat",
    cost:{min:14000, typ:22000, max:32000} },

  { id:"facade", label:"Fassade dämmen", savePctTyp:0.20, costModel:"m2_facade",
    cost:{min:90, typ:140, max:220} },

  { id:"roof", label:"Dach / oberste Geschossdecke", savePctTyp:0.18, costModel:"m2_roof",
    cost:{min:70, typ:110, max:180} },

  { id:"windows", label:"Fenster erneuern", savePctTyp:0.10, costModel:"per_m2_living",
    cost:{min:80, typ:120, max:200} },

  { id:"basement", label:"Kellerdecke dämmen", savePctTyp:0.07, costModel:"m2_floor",
    cost:{min:50, typ:90, max:140} }
];

/* =========================
   PARSING (DE/EN robust)
   - "0,12"  -> 0.12
   - "0.12"  -> 0.12
   - "1.234,56" -> 1234.56
   - "1,234.56" -> 1234.56
========================= */
function parseLocaleNumber(v){
  if(v === null || v === undefined) return 0;
  let s = String(v).trim();
  if(!s) return 0;
  s = s.replace(/\s/g, "");

  const hasComma = s.includes(",");
  const hasDot = s.includes(".");

  if(hasComma && hasDot){
    // Letztes Trennzeichen entscheidet Dezimaltrenner
    const lastComma = s.lastIndexOf(",");
    const lastDot = s.lastIndexOf(".");
    const decIsComma = lastComma > lastDot;

    if(decIsComma){
      // 1.234,56 -> tausender '.' raus, ',' -> '.'
      s = s.replace(/\./g, "").replace(",", ".");
    } else {
      // 1,234.56 -> tausender ',' raus
      s = s.replace(/,/g, "");
    }
  } else if(hasComma && !hasDot){
